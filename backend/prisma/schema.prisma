generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 审计日志模型 - 记录系统操作和安全事件
model audit_logs {
  id                 String                @id @db.Char(36)
  action             String                @db.VarChar(100)
  entity             String                @db.VarChar(100)
  entityId           String?               @map("entity_id") @db.VarChar(50)
  userId             Int?                  @map("user_id") @db.UnsignedInt
  userRole           String?               @map("user_role") @db.VarChar(50)
  description        String                @db.Text
  changes            Json?
  oldValues          Json?                 @map("old_values")
  newValues          Json?                 @map("new_values")
  requestInfo        Json?                 @map("request_info")
  sessionId          String?               @map("session_id") @db.VarChar(100)
  ipAddress          String?               @map("ip_address") @db.VarChar(45)
  userAgent          String?               @map("user_agent") @db.Text
  location           Json?
  result             audit_logs_result     @default(success)
  errorDetails       Json?                 @map("error_details")
  riskLevel          audit_logs_risk_level @default(low) @map("risk_level")
  securityFlags      Json?                 @map("security_flags")
  complianceFlags    Json?                 @map("compliance_flags")
  retentionPeriod    Int                   @default(2555) @map("retention_period")
  applicationVersion String?               @map("application_version") @db.VarChar(50)
  correlationId      String?               @map("correlation_id") @db.VarChar(100)
  parentLogId        String?               @map("parent_log_id") @db.Char(36)
  executionTime      Int?                  @map("execution_time")
  resourceUsage      Json?                 @map("resource_usage")
  isEncrypted        Boolean               @default(false) @map("is_encrypted")
  checksumHash       String?               @map("checksum_hash") @db.VarChar(64)
  archivedAt         DateTime?             @map("archived_at") @db.DateTime(0)
  isArchived         Boolean               @default(false) @map("is_archived")
  createdAt          DateTime              @map("created_at") @db.DateTime(0)
  updatedAt          DateTime              @map("updated_at") @db.DateTime(0)
  user               users?                @relation(fields: [userId], references: [id], map: "audit_logs_ibfk_1")
  parentLog          audit_logs?           @relation("AuditLogHierarchy", fields: [parentLogId], references: [id], map: "audit_logs_ibfk_2")
  childLogs          audit_logs[]          @relation("AuditLogHierarchy")
  securityEvents     security_events[]

  @@index([action], map: "audit_logs_action")
  @@index([userId, action, entity, createdAt], map: "audit_logs_comprehensive_search")
  @@index([correlationId], map: "audit_logs_correlation_id")
  @@index([createdAt], map: "audit_logs_created_at")
  @@index([entity], map: "audit_logs_entity")
  @@index([entityId], map: "audit_logs_entity_id")
  @@index([ipAddress], map: "audit_logs_ip_address")
  @@index([isArchived], map: "audit_logs_is_archived")
  @@index([result], map: "audit_logs_result")
  @@index([riskLevel], map: "audit_logs_risk_level")
  @@index([riskLevel, ipAddress, createdAt], map: "audit_logs_security_monitoring")
  @@index([sessionId], map: "audit_logs_session_id")
  @@index([userId], map: "audit_logs_user_id")
  @@index([parentLogId], map: "parent_log_id")
}

// 图书分类模型 - 管理图书的分类信息
model book_categories {
  id              Int               @id @default(autoincrement()) @db.UnsignedInt
  name            String            @unique(map: "name") @db.VarChar(50)
  code            String            @unique(map: "code") @db.VarChar(20)
  parentId        Int?              @map("parent_id") @db.UnsignedInt
  level           Int               @default(1) @db.UnsignedInt
  description     String?           @db.Text
  sortOrder       Int?              @default(0) @map("sort_order")
  isActive        Boolean?          @default(true) @map("is_active")
  bookCount       Int?              @default(0) @map("book_count") @db.UnsignedInt
  createdAt       DateTime          @map("created_at") @db.DateTime(0)
  updatedAt       DateTime          @map("updated_at") @db.DateTime(0)
  parentCategory  book_categories?  @relation("CategoryHierarchy", fields: [parentId], references: [id], map: "book_categories_ibfk_1")
  childCategories book_categories[] @relation("CategoryHierarchy")
  books           books[]

  @@index([code], map: "book_categories_code")
  @@index([name], map: "book_categories_name")
  @@index([parentId], map: "book_categories_parent_id")
  @@index([sortOrder], map: "book_categories_sort_order")
}

model book_locations {
  id          Int      @id @default(autoincrement()) @db.UnsignedInt
  name        String   @unique(map: "book_locations_name") @db.VarChar(100)
  code        String?  @unique(map: "book_locations_code") @db.VarChar(50)
  area        String?  @db.VarChar(100)
  floor       String?  @db.VarChar(50)
  shelf       String?  @db.VarChar(50)
  description String?  @db.Text
  capacity    Int?     @db.UnsignedInt
  sortOrder   Int?     @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.DateTime(0)
  books       books[]

  @@index([isActive], map: "book_locations_is_active")
  @@index([code], map: "book_locations_code_idx")
}

model book_tags {
  id               Int                  @id @default(autoincrement()) @db.UnsignedInt
  name             String               @unique(map: "book_tags_name") @db.VarChar(100)
  code             String?              @unique(map: "book_tags_code") @db.VarChar(50)
  color            String?              @db.VarChar(20)
  description      String?              @db.Text
  sortOrder        Int?                 @default(0) @map("sort_order")
  isActive         Boolean              @default(true) @map("is_active")
  createdAt        DateTime             @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt        DateTime             @default(now()) @updatedAt @map("updated_at") @db.DateTime(0)
  bookTagRelations book_tag_relations[]

  @@index([isActive], map: "book_tags_is_active")
  @@index([sortOrder], map: "book_tags_sort_order")
}

model book_tag_relations {
  bookId     Int      @map("book_id") @db.UnsignedInt
  tagId      Int      @map("tag_id") @db.UnsignedInt
  assignedAt DateTime @default(now()) @map("assigned_at") @db.DateTime(0)

  book books     @relation(fields: [bookId], references: [id], onDelete: Cascade, map: "book_tag_relations_book_id_fk")
  tag  book_tags @relation(fields: [tagId], references: [id], onDelete: Cascade, map: "book_tag_relations_tag_id_fk")

  @@id([bookId, tagId])
  @@index([tagId], map: "book_tag_relations_tag_id")
}

// 图书模型 - 存储图书的基本信息和状态
model books {
  id               Int                        @id @default(autoincrement()) @db.UnsignedInt
  title            String                     @db.VarChar(255)
  isbn             String                     @unique(map: "books_isbn") @db.VarChar(20)
  authors          Json // 作者信息(支持多作者)
  publisher        String?                    @db.VarChar(100)
  publicationYear  Int?                       @map("publication_year")
  language         String                     @default("zh-CN") @db.VarChar(20)
  categoryId       Int?                       @map("category_id") @db.UnsignedInt
  category         String?                    @db.VarChar(50)
  tags             Json?
  summary          String?                    @db.Text
  description      String?                    @db.Text
  coverImage       String?                    @map("cover_image") @db.VarChar(255)
  totalStock       Int                        @default(0) @map("total_stock") @db.UnsignedInt // 总库存
  availableStock   Int                        @default(0) @map("available_stock") @db.UnsignedInt // 可借数量
  reservedStock    Int                        @default(0) @map("reserved_stock") @db.UnsignedInt // 预约数量
  status           books_status               @default(available)
  locationId       Int?                       @map("location_id") @db.UnsignedInt
  location         String?                    @db.VarChar(50)
  price            Decimal?                   @db.Decimal(10, 2)
  pages            Int?                       @db.UnsignedInt
  format           String?                    @db.VarChar(20)
  ebookUrl         String?                    @map("ebook_url") @db.VarChar(500)
  ebookFormat      String?                    @map("ebook_format") @db.VarChar(20)
  ebookFileSize    BigInt?                    @map("ebook_file_size") @db.UnsignedBigInt
  hasEbook         Boolean?                   @default(false) @map("has_ebook")
  borrowCount      Int?                       @default(0) @map("borrow_count") @db.UnsignedInt // 借阅次数
  viewCount        Int?                       @default(0) @map("view_count") @db.UnsignedInt // 查看次数
  downloadCount    Int?                       @default(0) @map("download_count") @db.UnsignedInt // 下载次数
  averageRating    Decimal?                   @map("average_rating") @db.Decimal(3, 2) // 平均评分
  reviewCount      Int?                       @default(0) @map("review_count") @db.UnsignedInt // 评价数量
  condition        books_condition?           @default(new)
  notes            String?                    @db.Text
  isDeleted        Boolean?                   @default(false) @map("is_deleted")
  deletedAt        DateTime?                  @map("deleted_at") @db.DateTime(0)
  createdAt        DateTime                   @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt        DateTime                   @default(now()) @updatedAt @map("updated_at") @db.DateTime(0)
  bookCategory     book_categories?           @relation(fields: [categoryId], references: [id], map: "books_ibfk_1")
  borrows          borrows[]
  feedbacks        recommendation_feedbacks[]
  recommendations  recommendations[]
  reviews          reviews[]
  userBehaviors    user_behaviors[]
  bookFiles        book_files[]
  bookLocation     book_locations?            @relation(fields: [locationId], references: [id], map: "books_ibfk_location")
  bookTagRelations book_tag_relations[]

  @@index([averageRating], map: "books_average_rating")
  @@index([borrowCount], map: "books_borrow_count")
  @@index([category], map: "books_category")
  @@index([createdAt], map: "books_created_at")
  @@index([hasEbook], map: "books_has_ebook")
  @@index([publicationYear], map: "books_publication_year")
  @@index([publisher], map: "books_publisher")
  @@index([status], map: "books_status")
  @@index([title], map: "books_title")
  @@index([categoryId], map: "category_id")
  @@index([locationId], map: "books_location_id")
}

// 借阅记录模型 - 管理用户借阅和归还记录
model borrows {
  id                Int                @id @default(autoincrement()) @db.UnsignedInt
  userId            Int                @map("user_id") @db.UnsignedInt
  bookId            Int                @map("book_id") @db.UnsignedInt
  borrowDate        DateTime           @map("borrow_date") @db.DateTime(0)
  dueDate           DateTime           @map("due_date") @db.DateTime(0)
  returnDate        DateTime?          @map("return_date") @db.DateTime(0)
  actualReturnDate  DateTime?          @map("actual_return_date") @db.DateTime(0)
  status            borrows_status     @default(borrowed)
  borrowDays        Int                @default(30) @map("borrow_days") @db.UnsignedInt
  renewalCount      Int?               @default(0) @map("renewal_count") @db.UnsignedInt // 续借次数
  maxRenewals       Int?               @default(2) @map("max_renewals") @db.UnsignedInt // 最大续借次数
  overdueDays       Int?               @default(0) @map("overdue_days") @db.UnsignedInt // 逾期天数
  fine              Decimal?           @default(0.00) @db.Decimal(10, 2) // 罚金
  finePaid          Boolean?           @default(false) @map("fine_paid") // 罚金已支付
  condition         borrows_condition? @default(good)
  damageDescription String?            @map("damage_description") @db.Text
  returnNotes       String?            @map("return_notes") @db.Text
  borrowNotes       String?            @map("borrow_notes") @db.Text
  processedBy       Int?               @map("processed_by") @db.UnsignedInt
  isDeleted         Boolean?           @default(false) @map("is_deleted")
  createdAt         DateTime           @map("created_at") @db.DateTime(0)
  updatedAt         DateTime           @map("updated_at") @db.DateTime(0)
  borrower          users              @relation("UserBorrows", fields: [userId], references: [id], onDelete: Cascade, map: "borrows_ibfk_1")
  book              books              @relation(fields: [bookId], references: [id], onDelete: Cascade, map: "borrows_ibfk_2")
  processor         users?             @relation("BorrowProcessor", fields: [processedBy], references: [id], map: "borrows_ibfk_3")
  notifications     notifications[]
  reviews           reviews[]

  @@unique([userId, bookId], map: "borrows_bookId_userId_unique")
  @@unique([userId, bookId], map: "unique_active_borrow")
  @@index([bookId], map: "borrows_book_id")
  @@index([bookId, status], map: "borrows_book_id_status")
  @@index([borrowDate], map: "borrows_borrow_date")
  @@index([dueDate], map: "borrows_due_date")
  @@index([returnDate], map: "borrows_return_date")
  @@index([status], map: "borrows_status")
  @@index([userId], map: "borrows_user_id")
  @@index([userId, status], map: "borrows_user_id_status")
  @@index([processedBy], map: "processed_by")
}

// 登录尝试记录模型 - 记录登录行为和安全分析
model login_attempts {
  id                   String                         @id @db.Char(36)
  userId               Int?                           @map("user_id") @db.UnsignedInt
  username             String                         @db.VarChar(100)
  email                String?                        @db.VarChar(255)
  success              Boolean
  failureReason        login_attempts_failure_reason? @map("failure_reason")
  ipAddress            String                         @map("ip_address") @db.VarChar(45)
  userAgent            String?                        @map("user_agent") @db.Text
  geoLocation          Json?                          @map("geo_location")
  deviceInfo           Json?                          @map("device_info")
  deviceFingerprint    String?                        @map("device_fingerprint") @db.VarChar(64)
  loginMethod          login_attempts_login_method    @default(password) @map("login_method")
  oauthProvider        String?                        @map("oauth_provider") @db.VarChar(50)
  sessionId            String?                        @map("session_id") @db.VarChar(100)
  sessionDuration      Int?                           @map("session_duration")
  isSuspicious         Boolean                        @default(false) @map("is_suspicious")
  suspiciousReasons    Json?                          @map("suspicious_reasons")
  riskScore            Float                          @default(0) @map("risk_score") @db.Float
  threatDetected       Boolean                        @default(false) @map("threat_detected")
  threatType           login_attempts_threat_type?    @map("threat_type")
  mfaUsed              Boolean                        @default(false) @map("mfa_used")
  mfaMethod            login_attempts_mfa_method?     @map("mfa_method")
  attemptTime          DateTime                       @map("attempt_time") @db.DateTime(0)
  responseTime         Int?                           @map("response_time")
  previousAttempts     Int                            @default(0) @map("previous_attempts")
  userPreviousAttempts Int                            @default(0) @map("user_previous_attempts")
  blocked              Boolean                        @default(false)
  blockReason          String?                        @map("block_reason") @db.VarChar(200)
  blockDuration        Int?                           @map("block_duration")
  captchaRequired      Boolean                        @default(false) @map("captcha_required")
  captchaSolved        Boolean?                       @map("captcha_solved")
  referrer             String?                        @db.Text
  utmSource            String?                        @map("utm_source") @db.VarChar(100)
  correlationId        String?                        @map("correlation_id") @db.VarChar(100)
  securityEventId      String?                        @map("security_event_id") @db.Char(36)
  notes                String?                        @db.Text
  isEncrypted          Boolean                        @default(false) @map("is_encrypted")
  createdAt            DateTime                       @map("created_at") @db.DateTime(0)
  updatedAt            DateTime                       @map("updated_at") @db.DateTime(0)
  user                 users?                         @relation(fields: [userId], references: [id], map: "login_attempts_ibfk_1")
  securityEvent        security_events?               @relation(fields: [securityEventId], references: [id], map: "login_attempts_ibfk_2")

  @@index([attemptTime], map: "login_attempts_attempt_time")
  @@index([blocked], map: "login_attempts_blocked")
  @@index([correlationId], map: "login_attempts_correlation_id")
  @@index([deviceFingerprint], map: "login_attempts_device_fingerprint")
  @@index([ipAddress], map: "login_attempts_ip_address")
  @@index([isSuspicious], map: "login_attempts_is_suspicious")
  @@index([ipAddress, attemptTime, success], map: "login_attempts_security_monitoring")
  @@index([success], map: "login_attempts_success")
  @@index([threatDetected], map: "login_attempts_threat_detected")
  @@index([threatDetected, isSuspicious, attemptTime], map: "login_attempts_threat_detection")
  @@index([username, attemptTime, success], map: "login_attempts_user_analysis")
  @@index([userId], map: "login_attempts_user_id")
  @@index([username], map: "login_attempts_username")
  @@index([securityEventId], map: "security_event_id")
}

// 通知模板模型 - 定义系统通知的模板
model notification_templates {
  id              Int                              @id @default(autoincrement()) @db.UnsignedInt
  code            String                           @unique(map: "code") @db.VarChar(100)
  name            String                           @db.VarChar(255)
  type            notification_templates_type
  title           String                           @db.VarChar(255)
  content         String                           @db.Text
  smsContent      String?                          @map("sms_content") @db.Text
  pushTitle       String?                          @map("push_title") @db.VarChar(255)
  pushContent     String?                          @map("push_content") @db.Text
  priority        notification_templates_priority? @default(normal)
  isActive        Boolean?                         @default(true) @map("is_active")
  variables       Json?
  defaultChannels Json?                            @map("default_channels")
  conditions      Json?
  metadata        Json?
  createdAt       DateTime                         @map("created_at") @db.DateTime(0)
  updatedAt       DateTime                         @map("updated_at") @db.DateTime(0)

  @@index([isActive], map: "notification_templates_is_active")
  @@index([type], map: "notification_templates_type")
}

// 通知模型 - 管理用户通知消息
model notifications {
  id            Int                     @id @default(autoincrement()) @db.UnsignedInt
  userId        Int?                    @map("user_id") @db.UnsignedInt
  type          notifications_type
  title         String                  @db.VarChar(255)
  content       String                  @db.Text
  priority      notifications_priority? @default(normal)
  status        notifications_status?   @default(pending)
  isRead        Boolean?                @default(false) @map("is_read")
  readAt        DateTime?               @map("read_at") @db.DateTime(0)
  metadata      Json?
  relatedId     Int?                    @map("related_id") @db.UnsignedInt
  relatedType   String?                 @map("related_type") @db.VarChar(50)
  actionUrl     String?                 @map("action_url") @db.VarChar(500)
  createdAt     DateTime                @map("created_at") @db.DateTime(0)
  updatedAt     DateTime                @map("updated_at") @db.DateTime(0)
  deletedAt     DateTime?               @map("deleted_at") @db.DateTime(0)
  relatedBorrow borrows?                @relation(fields: [relatedId], references: [id], onDelete: Cascade, map: "notifications_ibfk_2")

  @@index([createdAt], map: "notifications_created_at")
  @@index([relatedId, relatedType], map: "notifications_related_id_related_type")
  @@index([type, priority], map: "notifications_type_priority")
  @@index([userId, status], map: "notifications_user_id_status")
}

// 积分交易记录模型 - 记录用户积分变化
model points_transactions {
  id                BigInt                               @id @default(autoincrement()) @db.UnsignedBigInt
  userId            Int                                  @map("user_id") @db.UnsignedInt
  pointsChange      Int                                  @map("points_change")
  currentBalance    Int                                  @map("current_balance")
  previousBalance   Int?                                 @map("previous_balance")
  transactionType   points_transactions_transaction_type @map("transaction_type")
  description       String                               @db.VarChar(255)
  relatedEntityType String?                              @map("related_entity_type") @db.VarChar(50)
  relatedEntityId   Int?                                 @map("related_entity_id") @db.UnsignedInt
  metadata          Json?
  processedBy       Int?                                 @map("processed_by") @db.UnsignedInt
  status            points_transactions_status?          @default(completed)
  createdAt         DateTime                             @map("created_at") @db.DateTime(0)
  updatedAt         DateTime                             @map("updated_at") @db.DateTime(0)
  user              users                                @relation("UserPointsTransactions", fields: [userId], references: [id], onDelete: Cascade, map: "points_transactions_ibfk_1")
  processor         users?                               @relation("PointsTransactionProcessor", fields: [processedBy], references: [id], map: "points_transactions_ibfk_2")

  @@index([createdAt], map: "points_transactions_created_at")
  @@index([processedBy], map: "points_transactions_processed_by")
  @@index([relatedEntityType, relatedEntityId], map: "points_transactions_related_entity_type_related_entity_id")
  @@index([status], map: "points_transactions_status")
  @@index([transactionType], map: "points_transactions_transaction_type")
  @@index([userId], map: "points_transactions_user_id")
  @@index([userId, createdAt], map: "points_transactions_user_id_created_at")
  @@index([userId, transactionType], map: "points_transactions_user_id_transaction_type")
}

// 推荐反馈模型 - 记录用户对推荐结果的反馈
model recommendation_feedbacks {
  id                 Int                                          @id @default(autoincrement()) @db.UnsignedInt
  userId             Int                                          @map("user_id") @db.UnsignedInt
  recommendationId   Int?                                         @map("recommendation_id") @db.UnsignedInt
  bookId             Int                                          @map("book_id") @db.UnsignedInt
  feedbackType       recommendation_feedbacks_feedback_type       @map("feedback_type")
  feedbackValue      Float                                        @map("feedback_value") @db.Float
  rawFeedbackValue   String?                                      @map("raw_feedback_value") @db.VarChar(100)
  feedbackDimensions Json?                                        @map("feedback_dimensions")
  confidence         Float                                        @default(1) @db.Float
  feedbackContext    Json?                                        @map("feedback_context")
  feedbackMotivation recommendation_feedbacks_feedback_motivation @default(voluntary) @map("feedback_motivation")
  feedbackContent    Json?                                        @map("feedback_content")
  feedbackQuality    Json?                                        @map("feedback_quality")
  userState          Json?                                        @map("user_state")
  algorithmInfo      Json?                                        @map("algorithm_info")
  temporalInfo       Json?                                        @map("temporal_info")
  socialInfo         Json?                                        @map("social_info")
  verificationStatus recommendation_feedbacks_verification_status @default(unverified) @map("verification_status")
  processingStatus   recommendation_feedbacks_processing_status   @default(pending) @map("processing_status")
  processedAt        DateTime?                                    @map("processed_at") @db.DateTime(0)
  feedbackImpact     Json?                                        @map("feedback_impact")
  weight             Float                                        @default(1) @db.Float
  isTrainingData     Boolean                                      @default(true) @map("is_training_data")
  tags               Json?
  metadata           Json?
  createdAt          DateTime                                     @map("created_at") @db.DateTime(0)
  updatedAt          DateTime                                     @map("updated_at") @db.DateTime(0)
  deletedAt          DateTime?                                    @map("deleted_at") @db.DateTime(0)
  user               users                                        @relation(fields: [userId], references: [id], onDelete: Cascade, map: "recommendation_feedbacks_ibfk_1")
  recommendation     recommendations?                             @relation(fields: [recommendationId], references: [id], map: "recommendation_feedbacks_ibfk_2")
  book               books                                        @relation(fields: [bookId], references: [id], onDelete: Cascade, map: "recommendation_feedbacks_ibfk_3")

  @@index([bookId], map: "recommendation_feedbacks_book_id")
  @@index([createdAt], map: "recommendation_feedbacks_created_at")
  @@index([feedbackType], map: "recommendation_feedbacks_feedback_type")
  @@index([feedbackValue], map: "recommendation_feedbacks_feedback_value")
  @@index([isTrainingData], map: "recommendation_feedbacks_is_training_data")
  @@index([processedAt], map: "recommendation_feedbacks_processed_at")
  @@index([processingStatus], map: "recommendation_feedbacks_processing_status")
  @@index([recommendationId], map: "recommendation_feedbacks_recommendation_id")
  @@index([userId], map: "recommendation_feedbacks_user_id")
  @@index([userId, bookId], map: "recommendation_feedbacks_user_id_book_id")
  @@index([userId, feedbackType], map: "recommendation_feedbacks_user_id_feedback_type")
  @@index([verificationStatus], map: "recommendation_feedbacks_verification_status")
  @@index([weight], map: "recommendation_feedbacks_weight")
}

// 推荐算法模型 - 管理推荐系统的算法配置
model recommendation_models {
  id                  Int                                   @id @default(autoincrement()) @db.UnsignedInt
  name                String                                @unique(map: "name") @db.VarChar(200)
  type                recommendation_models_type
  description         String?                               @db.Text
  version             String                                @default("1.0.0") @db.VarChar(50)
  enabled             Boolean                               @default(true)
  isDefault           Boolean                               @default(false) @map("is_default")
  config              Json
  hyperparameters     Json?
  featureConfig       Json?                                 @map("feature_config")
  trainingStatus      recommendation_models_training_status @default(not_trained) @map("training_status")
  lastTrainedAt       DateTime?                             @map("last_trained_at") @db.DateTime(0)
  nextTrainingAt      DateTime?                             @map("next_training_at") @db.DateTime(0)
  trainingDataSize    Int?                                  @map("training_data_size")
  modelPath           String?                               @map("model_path") @db.VarChar(500)
  modelSize           BigInt?                               @map("model_size")
  performanceMetrics  Json?                                 @map("performance_metrics")
  abTestConfig        Json?                                 @map("ab_test_config")
  deploymentConfig    Json?                                 @map("deployment_config")
  monitoringConfig    Json?                                 @map("monitoring_config")
  dataVersion         String?                               @map("data_version") @db.VarChar(100)
  dependencies        Json?
  weight              Float                                 @default(1) @db.Float
  priority            Int                                   @default(5)
  applicableScenarios Json?                                 @map("applicable_scenarios")
  targetUserSegments  Json?                                 @map("target_user_segments")
  createdBy           Int?                                  @map("created_by") @db.UnsignedInt
  updatedBy           Int?                                  @map("updated_by") @db.UnsignedInt
  tags                Json?
  notes               String?                               @db.Text
  metadata            Json?
  createdAt           DateTime                              @map("created_at") @db.DateTime(0)
  updatedAt           DateTime                              @map("updated_at") @db.DateTime(0)
  deletedAt           DateTime?                             @map("deleted_at") @db.DateTime(0)
  creator             users?                                @relation("RecommendationModelCreator", fields: [createdBy], references: [id], map: "recommendation_models_ibfk_1")
  updater             users?                                @relation("RecommendationModelUpdater", fields: [updatedBy], references: [id], map: "recommendation_models_ibfk_2")
  recommendations     recommendations[]

  @@index([createdBy], map: "recommendation_models_created_by")
  @@index([enabled], map: "recommendation_models_enabled")
  @@index([isDefault], map: "recommendation_models_is_default")
  @@index([lastTrainedAt], map: "recommendation_models_last_trained_at")
  @@index([priority], map: "recommendation_models_priority")
  @@index([trainingStatus], map: "recommendation_models_training_status")
  @@index([type], map: "recommendation_models_type")
  @@index([version], map: "recommendation_models_version")
  @@index([updatedBy], map: "updated_by")
}

// 推荐记录模型 - 存储生成的推荐结果
model recommendations {
  id                     Int                                 @id @default(autoincrement()) @db.UnsignedInt
  userId                 Int                                 @map("user_id") @db.UnsignedInt
  bookId                 Int                                 @map("book_id") @db.UnsignedInt
  modelId                Int                                 @map("model_id") @db.UnsignedInt
  algorithm              String                              @db.VarChar(100)
  score                  Float                               @db.Float
  rank                   Int?
  recommendationType     recommendations_recommendation_type @default(personalized) @map("recommendation_type")
  scenario               recommendations_scenario
  status                 recommendations_status              @default(generated)
  explanation            Json?
  context                Json?
  personalizationFactors Json?                               @map("personalization_factors")
  diversityInfo          Json?                               @map("diversity_info")
  experimentInfo         Json?                               @map("experiment_info")
  displayCount           Int                                 @default(0) @map("display_count")
  firstDisplayedAt       DateTime?                           @map("first_displayed_at") @db.DateTime(0)
  lastDisplayedAt        DateTime?                           @map("last_displayed_at") @db.DateTime(0)
  clickedAt              DateTime?                           @map("clicked_at") @db.DateTime(0)
  userFeedback           Json?                               @map("user_feedback")
  actualOutcome          Json?                               @map("actual_outcome")
  expiresAt              DateTime?                           @map("expires_at") @db.DateTime(0)
  priority               Int                                 @default(5)
  isRealTime             Boolean                             @default(false) @map("is_real_time")
  batchId                String?                             @map("batch_id") @db.VarChar(100)
  source                 recommendations_source              @default(system)
  performanceMetrics     Json?                               @map("performance_metrics")
  tags                   Json?
  metadata               Json?
  createdAt              DateTime                            @map("created_at") @db.DateTime(0)
  updatedAt              DateTime                            @map("updated_at") @db.DateTime(0)
  feedbacks              recommendation_feedbacks[]
  user                   users                               @relation(fields: [userId], references: [id], onDelete: Cascade, map: "recommendations_ibfk_1")
  book                   books                               @relation(fields: [bookId], references: [id], onDelete: Cascade, map: "recommendations_ibfk_2")
  model                  recommendation_models               @relation(fields: [modelId], references: [id], onDelete: Cascade, map: "recommendations_ibfk_3")
  userBehaviors          user_behaviors[]

  @@unique([userId, bookId, scenario, batchId], map: "recommendations_user_id_book_id_scenario_batch_id")
  @@index([batchId], map: "recommendations_batch_id")
  @@index([bookId], map: "recommendations_book_id")
  @@index([clickedAt], map: "recommendations_clicked_at")
  @@index([createdAt], map: "recommendations_created_at")
  @@index([expiresAt], map: "recommendations_expires_at")
  @@index([firstDisplayedAt], map: "recommendations_first_displayed_at")
  @@index([modelId], map: "recommendations_model_id")
  @@index([priority], map: "recommendations_priority")
  @@index([rank], map: "recommendations_rank")
  @@index([recommendationType], map: "recommendations_recommendation_type")
  @@index([scenario], map: "recommendations_scenario")
  @@index([score], map: "recommendations_score")
  @@index([status], map: "recommendations_status")
  @@index([userId], map: "recommendations_user_id")
  @@index([userId, scenario], map: "recommendations_user_id_scenario")
  @@index([userId, status], map: "recommendations_user_id_status")
}

// 书评模型 - 管理用户对图书的评价
model reviews {
  id                 Int            @id @default(autoincrement()) @db.UnsignedInt
  userId             Int            @map("user_id") @db.UnsignedInt
  bookId             Int            @map("book_id") @db.UnsignedInt
  borrowId           Int?           @map("borrow_id") @db.UnsignedInt
  rating             Int
  title              String?        @db.VarChar(100)
  content            String         @db.Text
  tags               Json?
  isRecommended      Boolean        @default(true) @map("is_recommended")
  helpfulCount       Int            @default(0) @map("helpful_count")
  unhelpfulCount     Int            @default(0) @map("unhelpful_count")
  status             reviews_status @default(published)
  moderatorId        Int?           @map("moderator_id") @db.UnsignedInt
  moderatorNotes     String?        @map("moderator_notes") @db.Text
  moderatedAt        DateTime?      @map("moderated_at") @db.DateTime(0)
  isVerifiedPurchase Boolean        @default(false) @map("is_verified_purchase")
  spoilerAlert       Boolean        @default(false) @map("spoiler_alert")
  language           String         @default("zh-CN") @db.VarChar(10)
  createdAt          DateTime       @map("created_at") @db.DateTime(0)
  updatedAt          DateTime       @map("updated_at") @db.DateTime(0)
  deletedAt          DateTime?      @map("deleted_at") @db.DateTime(0)
  reviewer           users          @relation("UserReviews", fields: [userId], references: [id], onDelete: Cascade, map: "reviews_ibfk_1")
  book               books          @relation(fields: [bookId], references: [id], onDelete: Cascade, map: "reviews_ibfk_2")
  borrow             borrows?       @relation(fields: [borrowId], references: [id], map: "reviews_ibfk_3")
  moderator          users?         @relation("ReviewModerator", fields: [moderatorId], references: [id], map: "reviews_ibfk_4")

  @@unique([userId, bookId], map: "uk_reviews_user_book")
  @@index([bookId], map: "idx_reviews_book_id")
  @@index([borrowId], map: "idx_reviews_borrow_id")
  @@index([createdAt], map: "idx_reviews_created_at")
  @@index([isRecommended], map: "idx_reviews_is_recommended")
  @@index([rating], map: "idx_reviews_rating")
  @@index([status], map: "idx_reviews_status")
  @@index([userId], map: "idx_reviews_user_id")
  @@index([moderatorId], map: "moderator_id")
}

// 安全事件模型 - 记录和管理安全相关事件
model security_events {
  id                 String                           @id @db.Char(36)
  eventType          security_events_event_type       @map("event_type")
  severity           security_events_severity         @default(medium)
  status             security_events_status           @default(new)
  userId             Int?                             @map("user_id") @db.UnsignedInt
  sourceIp           String?                          @map("source_ip") @db.VarChar(45)
  targetIp           String?                          @map("target_ip") @db.VarChar(45)
  requestMethod      String?                          @map("request_method") @db.VarChar(10)
  requestUrl         String?                          @map("request_url") @db.Text
  requestHeaders     Json?                            @map("request_headers")
  requestBody        String?                          @map("request_body") @db.Text
  responseCode       Int?                             @map("response_code")
  userAgent          String?                          @map("user_agent") @db.Text
  deviceFingerprint  String?                          @map("device_fingerprint") @db.VarChar(64)
  sessionId          String?                          @map("session_id") @db.VarChar(100)
  geoLocation        Json?                            @map("geo_location")
  title              String                           @db.VarChar(200)
  description        String                           @db.Text
  detectionMethod    security_events_detection_method @default(rule_based) @map("detection_method")
  detectionRule      String?                          @map("detection_rule") @db.VarChar(200)
  confidenceScore    Float                            @default(0.5) @map("confidence_score") @db.Float
  threatIndicators   Json?                            @map("threat_indicators")
  mitreTactics       Json?                            @map("mitre_tactics")
  mitreTechniques    Json?                            @map("mitre_techniques")
  affectedSystems    Json?                            @map("affected_systems")
  affectedData       Json?                            @map("affected_data")
  businessImpact     security_events_business_impact  @default(minimal) @map("business_impact")
  responseActions    Json?                            @map("response_actions")
  assignedTo         Int?                             @map("assigned_to") @db.UnsignedInt
  investigationNotes String?                          @map("investigation_notes") @db.Text
  detectedAt         DateTime                         @map("detected_at") @db.DateTime(0)
  firstSeenAt        DateTime?                        @map("first_seen_at") @db.DateTime(0)
  lastSeenAt         DateTime?                        @map("last_seen_at") @db.DateTime(0)
  acknowledgedAt     DateTime?                        @map("acknowledged_at") @db.DateTime(0)
  resolvedAt         DateTime?                        @map("resolved_at") @db.DateTime(0)
  parentEventId      String?                          @map("parent_event_id") @db.Char(36)
  correlationId      String?                          @map("correlation_id") @db.VarChar(100)
  auditLogId         String?                          @map("audit_log_id") @db.Char(36)
  externalEventId    String?                          @map("external_event_id") @db.VarChar(100)
  externalSystem     String?                          @map("external_system") @db.VarChar(100)
  occurrenceCount    Int                              @default(1) @map("occurrence_count")
  notificationSent   Boolean                          @default(false) @map("notification_sent")
  escalated          Boolean                          @default(false)
  isEncrypted        Boolean                          @default(false) @map("is_encrypted")
  retentionPeriod    Int                              @default(2555) @map("retention_period")
  createdAt          DateTime                         @map("created_at") @db.DateTime(0)
  updatedAt          DateTime                         @map("updated_at") @db.DateTime(0)
  loginAttempts      login_attempts[]
  affectedUser       users?                           @relation("SecurityEventUser", fields: [userId], references: [id], map: "security_events_ibfk_1")
  assignee           users?                           @relation("SecurityEventAssignee", fields: [assignedTo], references: [id], map: "security_events_ibfk_2")
  parentEvent        security_events?                 @relation("SecurityEventHierarchy", fields: [parentEventId], references: [id], map: "security_events_ibfk_3")
  childEvents        security_events[]                @relation("SecurityEventHierarchy")
  auditLog           audit_logs?                      @relation(fields: [auditLogId], references: [id], map: "security_events_ibfk_4")

  @@index([auditLogId], map: "audit_log_id")
  @@index([parentEventId], map: "parent_event_id")
  @@index([assignedTo], map: "security_events_assigned_to")
  @@index([correlationId, parentEventId], map: "security_events_correlation")
  @@index([correlationId], map: "security_events_correlation_id")
  @@index([detectedAt], map: "security_events_detected_at")
  @@index([eventType], map: "security_events_event_type")
  @@index([assignedTo, status, severity], map: "security_events_investigation")
  @@index([severity, status, detectedAt], map: "security_events_monitoring")
  @@index([severity], map: "security_events_severity")
  @@index([sourceIp], map: "security_events_source_ip")
  @@index([status], map: "security_events_status")
  @@index([userId], map: "security_events_user_id")
}

// 用户行为模型 - 追踪用户的操作行为
model user_behaviors {
  id                      Int                          @id @default(autoincrement()) @db.UnsignedInt
  userId                  Int                          @map("user_id") @db.UnsignedInt
  bookId                  Int?                         @map("book_id") @db.UnsignedInt
  behaviorType            user_behaviors_behavior_type @map("behavior_type")
  intensity               Float                        @default(1) @db.Float
  duration                Int?
  context                 Json?
  searchQuery             String?                      @map("search_query") @db.VarChar(500)
  ratingValue             Float?                       @map("rating_value") @db.Float
  recommendationId        Int?                         @map("recommendation_id") @db.UnsignedInt
  recommendationAlgorithm String?                      @map("recommendation_algorithm") @db.VarChar(100)
  recommendationPosition  Int?                         @map("recommendation_position")
  feedback                user_behaviors_feedback?
  sessionInfo             Json?                        @map("session_info")
  experimentId            String?                      @map("experiment_id") @db.VarChar(100)
  experimentVariant       String?                      @map("experiment_variant") @db.VarChar(50)
  ipAddress               String?                      @map("ip_address") @db.VarChar(45)
  userAgent               String?                      @map("user_agent") @db.Text
  processed               Boolean                      @default(false)
  processedAt             DateTime?                    @map("processed_at") @db.DateTime(0)
  isImplicit              Boolean                      @default(true) @map("is_implicit")
  confidenceScore         Float?                       @map("confidence_score") @db.Float
  isAnomaly               Boolean                      @default(false) @map("is_anomaly")
  metadata                Json?
  createdAt               DateTime                     @map("created_at") @db.DateTime(0)
  updatedAt               DateTime                     @map("updated_at") @db.DateTime(0)
  user                    users                        @relation(fields: [userId], references: [id], onDelete: Cascade, map: "user_behaviors_ibfk_1")
  book                    books?                       @relation(fields: [bookId], references: [id], onDelete: Cascade, map: "user_behaviors_ibfk_2")
  recommendation          recommendations?             @relation(fields: [recommendationId], references: [id], map: "user_behaviors_ibfk_3")

  @@index([behaviorType], map: "user_behaviors_behavior_type")
  @@index([bookId], map: "user_behaviors_book_id")
  @@index([createdAt], map: "user_behaviors_created_at")
  @@index([experimentId], map: "user_behaviors_experiment_id")
  @@index([isAnomaly], map: "user_behaviors_is_anomaly")
  @@index([processed], map: "user_behaviors_processed")
  @@index([recommendationId], map: "user_behaviors_recommendation_id")
  @@index([userId], map: "user_behaviors_user_id")
  @@index([userId, behaviorType], map: "user_behaviors_user_id_behavior_type")
  @@index([userId, bookId], map: "user_behaviors_user_id_book_id")
}

// 用户积分模型 - 管理用户积分余额和等级
model user_points {
  userId              Int       @id @map("user_id") @db.UnsignedInt
  balance             Int       @default(0) // 积分余额
  totalEarned         Int?      @default(0) @map("total_earned") @db.UnsignedInt // 总获得积分
  totalSpent          Int?      @default(0) @map("total_spent") @db.UnsignedInt // 总消耗积分
  level               String    @default("NEWCOMER") @db.VarChar(20) // 用户等级代码
  levelName           String    @default("新手读者") @map("level_name") @db.VarChar(50) // 等级显示名称
  nextLevelPoints     Int?      @map("next_level_points") @db.UnsignedInt
  progressToNextLevel Decimal?  @default(0.00) @map("progress_to_next_level") @db.Decimal(5, 2)
  lastTransactionAt   DateTime? @map("last_transaction_at") @db.DateTime(0)
  createdAt           DateTime  @map("created_at") @db.DateTime(0)
  updatedAt           DateTime  @map("updated_at") @db.DateTime(0)
  user                users     @relation(fields: [userId], references: [id], onDelete: Cascade, map: "user_points_ibfk_1")

  @@index([balance], map: "user_points_balance")
  @@index([lastTransactionAt], map: "user_points_last_transaction_at")
  @@index([level], map: "user_points_level")
  @@index([totalEarned], map: "user_points_total_earned")
}

// 用户偏好模型 - 存储个性化推荐的用户偏好
model user_preferences {
  id                      Int                                  @id @default(autoincrement()) @db.UnsignedInt
  userId                  Int                                  @unique(map: "user_id") @map("user_id") @db.UnsignedInt
  preferenceType          user_preferences_preference_type     @default(hybrid) @map("preference_type")
  categoryPreferences     Json?                                @map("category_preferences")
  authorPreferences       Json?                                @map("author_preferences")
  tagPreferences          Json?                                @map("tag_preferences")
  languagePreferences     Json?                                @map("language_preferences")
  publishYearPreferences  Json?                                @map("publish_year_preferences")
  pageCountPreferences    Json?                                @map("page_count_preferences")
  ratingPreferences       Json?                                @map("rating_preferences")
  popularityPreferences   Json?                                @map("popularity_preferences")
  diversityPreferences    Json?                                @map("diversity_preferences")
  temporalPreferences     Json?                                @map("temporal_preferences")
  contextualPreferences   Json?                                @map("contextual_preferences")
  socialPreferences       Json?                                @map("social_preferences")
  negativePreferences     Json?                                @map("negative_preferences")
  learningParameters      Json?                                @map("learning_parameters")
  personalizationStrength Float                                @default(0.5) @map("personalization_strength") @db.Float
  confidenceScore         Float                                @default(0.1) @map("confidence_score") @db.Float
  dataQualityScore        Float?                               @map("data_quality_score") @db.Float
  lastUpdateSource        user_preferences_last_update_source? @map("last_update_source")
  userProfile             Json?                                @map("user_profile")
  behaviorPatterns        Json?                                @map("behavior_patterns")
  interestEvolution       Json?                                @map("interest_evolution")
  similarUsers            Json?                                @map("similar_users")
  recommendationStats     Json?                                @map("recommendation_stats")
  feedbackHistory         Json?                                @map("feedback_history")
  coldStartInfo           Json?                                @map("cold_start_info")
  privacySettings         Json?                                @map("privacy_settings")
  experimentConfig        Json?                                @map("experiment_config")
  lastComputedAt          DateTime?                            @map("last_computed_at") @db.DateTime(0)
  nextUpdateAt            DateTime?                            @map("next_update_at") @db.DateTime(0)
  needsRecomputation      Boolean                              @default(true) @map("needs_recomputation")
  computationVersion      String?                              @map("computation_version") @db.VarChar(50)
  metadata                Json?
  createdAt               DateTime                             @map("created_at") @db.DateTime(0)
  updatedAt               DateTime                             @map("updated_at") @db.DateTime(0)
  user                    users                                @relation(fields: [userId], references: [id], onDelete: Cascade, map: "user_preferences_ibfk_1")

  @@index([confidenceScore], map: "user_preferences_confidence_score")
  @@index([lastComputedAt], map: "user_preferences_last_computed_at")
  @@index([needsRecomputation], map: "user_preferences_needs_recomputation")
  @@index([nextUpdateAt], map: "user_preferences_next_update_at")
  @@index([personalizationStrength], map: "user_preferences_personalization_strength")
  @@index([preferenceType], map: "user_preferences_preference_type")
}

// 用户模型 - 存储用户基本信息和账户状态
model users {
  id                          Int                        @id @default(autoincrement()) @db.UnsignedInt
  username                    String                     @unique(map: "username") @db.VarChar(50)
  email                       String?                    @unique(map: "email") @db.VarChar(100)
  passwordHash                String?                    @map("password_hash") @db.VarChar(255)
  realName                    String?                    @map("real_name") @db.VarChar(50)
  phone                       String?                    @db.VarChar(20)
  avatar                      String?                    @db.VarChar(255)
  role                        users_role                 @default(patron)
  status                      users_status               @default(active)
  lastLoginAt                 DateTime?                  @map("last_login_at") @db.DateTime(0)
  lastLoginIp                 String?                    @map("last_login_ip") @db.VarChar(45)
  isDeleted                   Boolean?                   @default(false) @map("is_deleted")
  deletedAt                   DateTime?                  @map("deleted_at") @db.DateTime(0)
  createdAt                   DateTime                   @map("created_at") @db.DateTime(0)
  updatedAt                   DateTime                   @map("updated_at") @db.DateTime(0)
  auditLogs                   audit_logs[]
  userBorrows                 borrows[]                  @relation("UserBorrows")
  processedBorrows            borrows[]                  @relation("BorrowProcessor")
  uploadedBookFiles           book_files[]
  loginAttempts               login_attempts[]
  pointsTransactions          points_transactions[]      @relation("UserPointsTransactions")
  processedPointsTransactions points_transactions[]      @relation("PointsTransactionProcessor")
  recommendationFeedbacks     recommendation_feedbacks[]
  createdRecommendationModels recommendation_models[]    @relation("RecommendationModelCreator")
  updatedRecommendationModels recommendation_models[]    @relation("RecommendationModelUpdater")
  recommendations             recommendations[]
  userReviews                 reviews[]                  @relation("UserReviews")
  moderatedReviews            reviews[]                  @relation("ReviewModerator")
  affectedBySecurityEvents    security_events[]          @relation("SecurityEventUser")
  assignedSecurityEvents      security_events[]          @relation("SecurityEventAssignee")
  userBehaviors               user_behaviors[]
  userPoints                  user_points?
  userPreferences             user_preferences?
  userRoles                   user_roles[]

  @@index([email], map: "users_email")
  @@index([isDeleted], map: "users_is_deleted")
  @@index([lastLoginAt], map: "users_last_login_at")
  @@index([role], map: "users_role")
  @@index([status], map: "users_status")
  @@index([username], map: "users_username")
}

// 安全事件类型
enum security_events_event_type {
  authentication_failure
  authorization_failure
  suspicious_login
  account_lockout
  privilege_escalation
  data_access_violation
  brute_force_attack
  sql_injection_attempt
  xss_attempt
  csrf_attempt
  malicious_file_upload
  suspicious_user_agent
  rate_limit_exceeded
  geo_location_anomaly
  unusual_access_pattern
  data_exfiltration
  configuration_change
  system_intrusion
  malware_detected
  security_policy_violation
  other
}

// 通知类型
enum notifications_type {
  system
  borrow_reminder
  return_reminder
  overdue_warning
  reservation
  review_reply
  points_change
  book_available
  maintenance
  announcement
  chat_message
  admin_alert
}

// 推荐模型类型
enum recommendation_models_type {
  collaborative_filtering
  content_based
  matrix_factorization
  deep_learning
  hybrid
  knowledge_based
  demographic
  contextual
  sequential
  multi_armed_bandit
  reinforcement_learning
  neural_collaborative
  autoencoders
  factorization_machines
  wide_and_deep
}

// 安全事件严重级别
enum security_events_severity {
  low
  medium
  high
  critical
}

// 用户偏好类型
enum user_preferences_preference_type {
  explicit
  implicit
  learned
  hybrid
}

// 通知模板类型
enum notification_templates_type {
  system
  borrow_reminder
  return_reminder
  overdue_warning
  reservation
  review_reply
  points_change
  book_available
  maintenance
  announcement
  chat_message
  admin_alert
}

// 安全事件状态
enum security_events_status {
  new
  investigating
  confirmed
  false_positive
  resolved
  closed
}

// 用户行为类型
enum user_behaviors_behavior_type {
  view
  search
  borrow
  return
  review
  rate
  bookmark
  share
  download
  read
  click
  hover
  scroll
  recommendation_click
  recommendation_dismiss
}

enum backup_schedules_backup_type {
  full
  incremental
  differential
  database_only
  files_only
  custom
}

// 推荐反馈类型
enum recommendation_feedbacks_feedback_type {
  explicit
  implicit
  rating
  thumbs
  survey
  interaction
  behavioral
  contextual
}

// 登录失败原因
enum login_attempts_failure_reason {
  invalid_credentials
  user_not_found
  account_disabled
  account_locked
  password_expired
  too_many_attempts
  suspicious_activity
  geo_location_blocked
  device_not_trusted
  mfa_required
  mfa_failed
  session_expired
  maintenance_mode
  rate_limited
  captcha_failed
  other
}

// 通知优先级
enum notifications_priority {
  low
  normal
  high
  urgent
}

// 积分交易类型
enum points_transactions_transaction_type {
  BORROW_BOOK
  RETURN_ON_TIME
  RETURN_LATE
  WRITE_REVIEW
  COMPLETE_TUTORIAL
  ADMIN_ADJUSTMENT
  PENALTY_DEDUCTION
  BONUS_REWARD
  REDEEM_REWARD
}

// 通知状态
enum notifications_status {
  pending
  sent
  read
  archived
}

// 借阅状态
enum borrows_status {
  borrowed
  returned
  overdue
  lost
  damaged
}

// 推荐类型
enum recommendations_recommendation_type {
  personalized
  similar_items
  popular
  trending
  collaborative
  content_based
  cold_start
  diversity
  serendipity
  contextual
  sequential
  cross_domain
  social
  location_based
  time_aware
}

// 推荐场景
enum recommendations_scenario {
  homepage
  book_detail
  user_profile
  search_results
  category_browse
  email_campaign
  mobile_app
  notification
  after_borrow
  after_return
  reading_list
  wishlist
  social_share
}

// 用户性别
enum users_gender {
  male
  female
  other
}

// 推荐状态
enum recommendations_status {
  generated
  displayed
  clicked
  dismissed
  borrowed
  rated
  shared
  expired
}

enum recommendation_feedbacks_feedback_motivation {
  voluntary
  prompted
  required
  incentivized
  passive
  survey_based
  experiment
}

enum recommendation_models_training_status {
  not_trained
  training
  trained
  updating
  failed
  deprecated
}

enum login_attempts_login_method {
  password
  oauth
  sso
  api_key
  token
  biometric
  other
}

enum notification_templates_priority {
  low
  normal
  high
  urgent
}

enum reviews_status {
  pending
  published
  hidden
  deleted
}

enum points_transactions_status {
  pending
  completed
  failed
  reversed
}

enum user_behaviors_feedback {
  positive
  negative
  neutral
}

enum backup_storages_connection_status {
  connected
  disconnected
  error
  testing
  unknown
}

enum borrows_condition {
  good
  damaged
  lost
}

enum audit_logs_result {
  success
  failure
  partial
  error
}

enum backup_schedules_last_run_status {
  success
  failed
  timeout
  cancelled
  skipped
}

enum audit_logs_risk_level {
  low
  medium
  high
  critical
}

enum recommendation_feedbacks_verification_status {
  unverified
  verified
  suspicious
  flagged
  validated
}

// 用户角色
enum users_role {
  admin
  librarian
  patron
}

enum backup_jobs_storage_backend {
  local
  s3
  ftp
  sftp
  azure
  gcs
  dropbox
  custom
}

enum recommendation_feedbacks_processing_status {
  pending
  processing
  processed
  incorporated
  ignored
  flagged
}

enum security_events_detection_method {
  rule_based
  ml_based
  manual
  third_party
  automated
}

// 用户状态
enum users_status {
  active
  inactive
  suspended
  banned
}

enum login_attempts_threat_type {
  brute_force
  credential_stuffing
  dictionary_attack
  bot
  malware
  other
}

enum user_preferences_last_update_source {
  explicit_feedback
  implicit_behavior
  batch_learning
  real_time_update
  manual_adjustment
  model_inference
}

// 图书状态
enum books_status {
  available
  borrowed
  reserved
  maintenance
  retired
}

enum login_attempts_mfa_method {
  sms
  email
  app
  hardware_token
  biometric
}

enum recommendations_source {
  system
  manual
  api
  batch_job
  real_time
  hybrid
  fallback
}

enum security_events_business_impact {
  none
  minimal
  moderate
  significant
  severe
}

enum backup_jobs_trigger {
  manual
  scheduled
  api
  event
  auto
}

// 图书品相
enum books_condition {
  new
  good
  fair
  poor
  damaged
}

// 书籍文件类型
enum book_files_file_type {
  pdf
  epub
  mobi
  txt
  doc
  docx
  other
}

// 书籍文件模型 - 管理电子书文件的存储和访问
model book_files {
  id            Int                  @id @default(autoincrement()) @db.UnsignedInt
  bookId        Int                  @map("book_id") @db.UnsignedInt
  fileName      String               @map("file_name") @db.VarChar(255)
  filePath      String               @map("file_path") @db.VarChar(500)
  fileUrl       String?              @map("file_url") @db.VarChar(500)
  fileType      book_files_file_type @default(pdf) @map("file_type")
  fileSize      BigInt?              @default(0) @map("file_size") @db.UnsignedBigInt
  mimeType      String?              @map("mime_type") @db.VarChar(100)
  uploadUserId  Int?                 @map("upload_user_id") @db.UnsignedInt
  downloadCount Int                  @default(0) @map("download_count") @db.UnsignedInt
  viewCount     Int                  @default(0) @map("view_count") @db.UnsignedInt
  isPrimary     Boolean              @default(false) @map("is_primary")
  isActive      Boolean              @default(true) @map("is_active")
  description   String?              @db.Text
  createdAt     DateTime             @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt     DateTime             @default(now()) @updatedAt @map("updated_at") @db.DateTime(0)

  book       books  @relation(fields: [bookId], references: [id], onDelete: Cascade, map: "book_files_ibfk_1")
  uploadUser users? @relation(fields: [uploadUserId], references: [id], onDelete: SetNull, map: "book_files_ibfk_2")

  @@index([bookId], map: "book_files_book_id")
  @@index([fileType], map: "book_files_file_type")
  @@index([isActive], map: "book_files_is_active")
  @@index([createdAt], map: "book_files_created_at")
}

// =========================
// RBAC Models (Roles & Permissions)
// =========================

/// 系统角色表
model roles {
  id          Int      @id @default(autoincrement()) @db.UnsignedInt
  name        String   @unique(map: "uk_roles_name") @db.VarChar(100)
  code        String   @unique(map: "uk_roles_code") @db.VarChar(100)
  description String?  @db.Text
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.DateTime(0)

  userRoles       user_roles[]
  rolePermissions role_permissions[]

  @@index([code], map: "idx_roles_code")
}

/// 系统权限表
model permissions {
  id          Int      @id @default(autoincrement()) @db.UnsignedInt
  name        String   @db.VarChar(150)
  code        String   @unique(map: "uk_permissions_code") @db.VarChar(150)
  groupName   String?  @map("group_name") @db.VarChar(100)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.DateTime(0)

  rolePermissions     role_permissions[]
  permissionResources permission_resources[]

  @@index([code], map: "idx_permissions_code")
  @@index([groupName], map: "idx_permissions_group")
}

/// 用户-角色 关联表（多对多）
model user_roles {
  id        Int      @id @default(autoincrement()) @db.UnsignedInt
  userId    Int      @map("user_id") @db.UnsignedInt
  roleId    Int      @map("role_id") @db.UnsignedInt
  createdAt DateTime @default(now()) @map("created_at") @db.DateTime(0)

  user users @relation(fields: [userId], references: [id], onDelete: Cascade, map: "fk_user_roles_user")
  role roles @relation(fields: [roleId], references: [id], onDelete: Cascade, map: "fk_user_roles_role")

  @@unique([userId, roleId], map: "uk_user_roles_user_role")
  @@index([userId], map: "idx_user_roles_user")
  @@index([roleId], map: "idx_user_roles_role")
}

/// 角色-权限 关联表（多对多）
model role_permissions {
  id           Int      @id @default(autoincrement()) @db.UnsignedInt
  roleId       Int      @map("role_id") @db.UnsignedInt
  permissionId Int      @map("permission_id") @db.UnsignedInt
  createdAt    DateTime @default(now()) @map("created_at") @db.DateTime(0)

  role       roles       @relation(fields: [roleId], references: [id], onDelete: Cascade, map: "fk_role_permissions_role")
  permission permissions @relation(fields: [permissionId], references: [id], onDelete: Cascade, map: "fk_role_permissions_permission")

  @@unique([roleId, permissionId], map: "uk_role_permissions_role_permission")
  @@index([roleId], map: "idx_role_permissions_role")
  @@index([permissionId], map: "idx_role_permissions_permission")
}

// UI 资源与权限绑定，用于描述路由、菜单与按钮等前端资源
enum permission_resource_type {
  ROUTE
  BUTTON
}

model permission_resources {
  id           Int                      @id @default(autoincrement()) @db.UnsignedInt
  permissionId Int?                     @map("permission_id") @db.UnsignedInt
  type         permission_resource_type @default(ROUTE)
  resourceKey  String                   @map("resource_key") @db.VarChar(150)
  resourceName String?                  @map("resource_name") @db.VarChar(150)
  routePath    String?                  @map("route_path") @db.VarChar(200)
  routeName    String?                  @map("route_name") @db.VarChar(120)
  component    String?                  @db.VarChar(200)
  parentKey    String?                  @map("parent_key") @db.VarChar(150)
  meta         Json?
  sortOrder    Int                      @default(0) @map("sort_order")
  isActive     Boolean                  @default(true) @map("is_active")
  createdAt    DateTime                 @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt    DateTime                 @default(now()) @updatedAt @map("updated_at") @db.DateTime(0)

  permission permissions? @relation(fields: [permissionId], references: [id], onDelete: SetNull, map: "fk_permission_resources_permission")

  @@unique([type, resourceKey], map: "uk_permission_resources_key")
  @@index([permissionId], map: "idx_permission_resources_permission")
  @@index([parentKey], map: "idx_permission_resources_parent")
  @@index([routeName], map: "idx_permission_resources_route_name")
}
